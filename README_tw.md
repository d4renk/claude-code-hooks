# Claude Code Hooks å®Œæ•´æŒ‡å—

> é€éè¨»å†Š shell å‘½ä»¤ï¼Œå®¢è£½åŒ–ä¸¦æ“´å±•æ‚¨çš„ Claude Code å·¥ä½œæµç¨‹ã€‚

## ğŸ“– ç›®éŒ„

- [ç¸½è¦½](#ç¸½è¦½)
  - [ä»€éº¼æ˜¯ Hooksï¼Ÿ](#ä»€éº¼æ˜¯-hooks)
  - [ç‚ºä»€éº¼è¦ä½¿ç”¨ Hooksï¼Ÿ](#ç‚ºä»€éº¼è¦ä½¿ç”¨-hooks)
- [å…¥é–€æ•™å­¸](#å…¥é–€æ•™å­¸)
  - [æ­¥é©Ÿ 1ï¼šæ‚¨çš„ç¬¬ä¸€å€‹ Hook - æª”æ¡ˆè®Šæ›´æ—¥èªŒ](#æ­¥é©Ÿ-1æ‚¨çš„ç¬¬ä¸€å€‹-hook---æª”æ¡ˆè®Šæ›´æ—¥èªŒ)
  - [æ­¥é©Ÿ 2ï¼šåŠ å…¥æ¢ä»¶ - ä½¿ç”¨åŒ¹é…å™¨](#æ­¥é©Ÿ-2åŠ å…¥æ¢ä»¶---ä½¿ç”¨åŒ¹é…å™¨)
  - [æ­¥é©Ÿ 3ï¼šèˆ‡ Claude äº’å‹• - è¨˜éŒ„åŸ·è¡Œçš„å‘½ä»¤](#æ­¥é©Ÿ-3èˆ‡-claude-äº’å‹•---è¨˜éŒ„åŸ·è¡Œçš„å‘½ä»¤)
- [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
  - [Hook äº‹ä»¶ç”Ÿå‘½é€±æœŸ](#hook-äº‹ä»¶ç”Ÿå‘½é€±æœŸ)
  - [Hook çš„è¼¸å…¥ (stdin)](#hook-çš„è¼¸å…¥-stdin)
  - [Hook çš„è¼¸å‡ºèˆ‡æ§åˆ¶](#hook-çš„è¼¸å‡ºèˆ‡æ§åˆ¶)
  - [è¨­å®šæª”ä½ç½®](#è¨­å®šæª”ä½ç½®)
- [å¯¦ç”¨ç¯„ä¾‹åº«](#å¯¦ç”¨ç¯„ä¾‹åº«)
  - [ç¨‹å¼ç¢¼è‡ªå‹•æ ¼å¼åŒ–](#1-ç¨‹å¼ç¢¼è‡ªå‹•æ ¼å¼åŒ–)
  - [é€²éšï¼šä½¿ç”¨ Python è…³æœ¬é€²è¡Œæ™ºæ…§é©—è­‰](#2-é€²éšä½¿ç”¨-python-è…³æœ¬é€²è¡Œæ™ºæ…§é©—è­‰)
  - [è‡ªè¨‚é€šçŸ¥ç³»çµ±](#3-è‡ªè¨‚é€šçŸ¥ç³»çµ±)
  - [å®‰å…¨é˜²è­·ç¯„ä¾‹](#4-å®‰å…¨é˜²è­·ç¯„ä¾‹)
  - [å®˜æ–¹ç¯„ä¾‹ï¼šBash å‘½ä»¤é©—è­‰](#5-å®˜æ–¹ç¯„ä¾‹bash-å‘½ä»¤é©—è­‰)
  - [å®˜æ–¹ç¯„ä¾‹ï¼šä½¿ç”¨è€…æç¤ºé©—è­‰èˆ‡ä¸Šä¸‹æ–‡æ·»åŠ ](#6-å®˜æ–¹ç¯„ä¾‹ä½¿ç”¨è€…æç¤ºé©—è­‰èˆ‡ä¸Šä¸‹æ–‡æ·»åŠ )
  - [æ™ºæ…§å‚™ä»½ç³»çµ±](#7-æ™ºæ…§å‚™ä»½ç³»çµ±)
  - [è‡ªå‹•æ¸¬è©¦åŸ·è¡Œ](#8-è‡ªå‹•æ¸¬è©¦åŸ·è¡Œ)
- [Hook åŸ·è¡Œç´°ç¯€](#hook-åŸ·è¡Œç´°ç¯€)
  - [åŸ·è¡Œç’°å¢ƒèˆ‡é™åˆ¶](#åŸ·è¡Œç’°å¢ƒèˆ‡é™åˆ¶)
  - [Hook åŒ¹é…è¦å‰‡](#hook-åŒ¹é…è¦å‰‡)
  - [å¸¸è¦‹å·¥å…·åŒ¹é…å™¨](#å¸¸è¦‹å·¥å…·åŒ¹é…å™¨)
- [é€²éšåŠŸèƒ½](#é€²éšåŠŸèƒ½)
  - [MCP å·¥å…·æ•´åˆ](#mcp-å·¥å…·æ•´åˆ)
  - [ä½¿ç”¨å¤–éƒ¨è…³æœ¬](#ä½¿ç”¨å¤–éƒ¨è…³æœ¬)
- [å®‰å…¨è€ƒé‡](#å®‰å…¨è€ƒé‡)
  - [å…è²¬è²æ˜](#å…è²¬è²æ˜)
  - [é‡è¦å®‰å…¨åŸå‰‡](#é‡è¦å®‰å…¨åŸå‰‡)
  - [å…·é«”é˜²è­·æªæ–½](#å…·é«”é˜²è­·æªæ–½)
  - [å°ˆæ¡ˆè¨­å®šå®‰å…¨æ€§](#å°ˆæ¡ˆè¨­å®šå®‰å…¨æ€§)
- [ç–‘é›£æ’è§£](#ç–‘é›£æ’è§£)
  - [å¸¸è¦‹å•é¡ŒåŠè§£æ±ºæ–¹æ¡ˆ](#å¸¸è¦‹å•é¡ŒåŠè§£æ±ºæ–¹æ¡ˆ)
  - [é™¤éŒ¯å·¥å…·](#é™¤éŒ¯å·¥å…·)
- [æœ€ä½³å¯¦è¸ç¸½çµ](#æœ€ä½³å¯¦è¸ç¸½çµ)
  - [æ¨è–¦åšæ³•](#æ¨è–¦åšæ³•)
  - [é¿å…äº‹é …](#é¿å…äº‹é …)
  - [é€²éšæŠ€å·§](#é€²éšæŠ€å·§)
- [çµèª](#çµèª)
- [åƒè€ƒè³‡æº](#åƒè€ƒè³‡æº)

## ç¸½è¦½

### ä»€éº¼æ˜¯ Hooksï¼Ÿ

Hooks æ˜¯æ‚¨å®šç¾©çš„ shell å‘½ä»¤ï¼Œå®ƒå€‘æœƒåœ¨ Claude Code ç”Ÿå‘½é€±æœŸçš„ç‰¹å®šæ™‚é–“é»è‡ªå‹•åŸ·è¡Œã€‚æ‚¨å¯ä»¥æŠŠå®ƒå€‘æƒ³åƒæˆæ˜¯ç‚ºæ‚¨çš„ AI ç¨‹å¼è¨­è¨ˆå¤¥ä¼´è¨­å®šçš„ã€Œè‡ªå‹•åŒ–è¦å‰‡ã€æˆ–ã€Œè§¸ç™¼å™¨ã€ã€‚

èˆ‡å…¶åœ¨æç¤ºä¸­åè¦†å‘Šè¨´ Claude è¦éµå®ˆæŸäº›è¦å‰‡ï¼Œä¸å¦‚å°‡é€™äº›è¦å‰‡ç·¨ç¢¼ç‚º Hooksï¼Œä½¿å…¶æˆç‚ºæ‚¨é–‹ç™¼ç’°å¢ƒä¸­å¯é ä¸”è‡ªå‹•åŒ–çš„ä¸€éƒ¨åˆ†ã€‚

### ç‚ºä»€éº¼è¦ä½¿ç”¨ Hooksï¼Ÿ

Hooks è®“æ‚¨èƒ½å¤ å° Claude Code çš„è¡Œç‚ºé€²è¡Œç¢ºå®šæ€§çš„æ§åˆ¶ï¼Œç¢ºä¿æŸäº›å‹•ä½œç¸½æ˜¯æœƒç™¼ç”Ÿã€‚å¸¸è¦‹çš„ä½¿ç”¨æƒ…å¢ƒåŒ…æ‹¬ï¼š

*   **âœï¸ è‡ªå‹•æ ¼å¼åŒ–**: åœ¨ Claude æ¯æ¬¡ç·¨è¼¯å®Œç•¢å¾Œï¼Œè‡ªå‹•å° `.ts` æª”æ¡ˆåŸ·è¡Œ `prettier`ï¼Œæˆ–å° `.go` æª”æ¡ˆåŸ·è¡Œ `gofmt`ã€‚
*   **ğŸ”” è‡ªè¨‚é€šçŸ¥**: ç•¶ Claude ç­‰å¾…æ‚¨çš„æŒ‡ä»¤æˆ–åŸ·è¡Œæ¬Šé™æ™‚ï¼Œé€éç³»çµ±é€šçŸ¥æˆ–è²éŸ³æé†’æ‚¨ã€‚
*   **ğŸ›¡ï¸ å®‰å…¨é˜²è­·**: é˜»æ­¢ Claude åŸ·è¡Œå±éšªçš„å‘½ä»¤ï¼ˆä¾‹å¦‚ `rm -rf`ï¼‰æˆ–ä¿®æ”¹ç”Ÿç”¢ç’°å¢ƒçš„è¨­å®šæª”ã€‚
*   **ğŸ“ åˆè¦æ€§è¨˜éŒ„**: è¿½è¹¤æ‰€æœ‰ç”± Claude åŸ·è¡Œçš„ shell å‘½ä»¤ï¼Œä»¥æ»¿è¶³ç¨½æ ¸æˆ–é™¤éŒ¯éœ€æ±‚ã€‚
*   **ğŸ’¡ è‡ªå‹•å›é¥‹**: ç•¶ Claude ç”¢ç”Ÿçš„ç¨‹å¼ç¢¼ä¸ç¬¦åˆæ‚¨çš„å°ˆæ¡ˆè¦ç¯„æ™‚ï¼Œè‡ªå‹•å‘å®ƒæä¾›ä¿®æ­£å»ºè­°ã€‚


## å…¥é–€æ•™å­¸

æœ¬æ•™å­¸å°‡å¼•å°æ‚¨å»ºç«‹ä¸‰å€‹ Hooksï¼Œå¾ç°¡å–®åˆ°è¤‡é›œï¼Œé€æ­¥æŒæ¡æ ¸å¿ƒæ¦‚å¿µã€‚

### æ­¥é©Ÿ 1ï¼šæ‚¨çš„ç¬¬ä¸€å€‹ Hook - æª”æ¡ˆè®Šæ›´æ—¥èªŒ

æˆ‘å€‘çš„ç¬¬ä¸€å€‹ Hook éå¸¸ç°¡å–®ï¼šæ¯ç•¶ Claude å„²å­˜ä¸€å€‹æª”æ¡ˆæ™‚ï¼Œæˆ‘å€‘å°±åœ¨ä¸€å€‹æ—¥èªŒæª”ä¸­è¨˜éŒ„ä¸‹ä¾†ã€‚é€™å€‹ç¯„ä¾‹ä¸éœ€è¦ä»»ä½•å¤–éƒ¨å·¥å…·ã€‚

1.  åœ¨çµ‚ç«¯æ©Ÿä¸­åŸ·è¡Œ `/hooks` å‘½ä»¤ï¼Œæ‰“é–‹ Hooks è¨­å®šä»‹é¢ã€‚
2.  å¾äº‹ä»¶åˆ—è¡¨ä¸­é¸æ“‡ `PostToolUse`ã€‚é€™å€‹äº‹ä»¶æœƒåœ¨ Claude æˆåŠŸåŸ·è¡Œå·¥å…·**ä¹‹å¾Œ**è§¸ç™¼ã€‚
3.  é¸æ“‡ `+ Add new matcherâ€¦`ï¼Œè¼¸å…¥ `Write|Edit|MultiEdit` ä¾†åŒ¹é…æª”æ¡ˆæ“ä½œå·¥å…·ã€‚
4.  é¸æ“‡ `+ Add new hookâ€¦`ï¼Œç„¶å¾Œè¼¸å…¥ä»¥ä¸‹å‘½ä»¤ï¼š
    ```bash
    echo "Claude edited a file at $(date)" >> ~/.claude/file-edit-log.txt
    ```
5.  æŒ‰ `Enter` å„²å­˜ Hookã€‚ç³»çµ±æœƒè©¢å•æ‚¨å„²å­˜ä½ç½®ï¼Œé¸æ“‡ `User settings`ï¼ˆä½¿ç”¨è€…è¨­å®šï¼‰ï¼Œé€™æ¨£é€™å€‹ Hook å°±æœƒåœ¨æ‚¨æ‰€æœ‰çš„å°ˆæ¡ˆä¸­ç”Ÿæ•ˆã€‚
6.  æŒ‰ `Esc` é€€å‡ºè¨­å®šä»‹é¢ã€‚

**é©—è­‰ä¸€ä¸‹**ï¼šç¾åœ¨ï¼Œè«‹ Claude éš¨æ„ä¿®æ”¹æ‚¨å°ˆæ¡ˆä¸­çš„ä»»ä½•ä¸€å€‹æª”æ¡ˆã€‚å®Œæˆå¾Œï¼Œæª¢æŸ¥æ—¥èªŒæª”çš„å…§å®¹ï¼š

```bash
cat ~/.claude/file-edit-log.txt
```

æ‚¨æ‡‰è©²æœƒçœ‹åˆ°é¡ä¼¼ "Claude edited a file at [æ—¥æœŸæ™‚é–“]" çš„è¨Šæ¯ã€‚æ­å–œï¼Œæ‚¨å·²ç¶“æˆåŠŸå»ºç«‹äº†ç¬¬ä¸€å€‹ Hookï¼

### æ­¥é©Ÿ 2ï¼šåŠ å…¥æ¢ä»¶ - ä½¿ç”¨åŒ¹é…å™¨

ä¸Šä¸€å€‹ Hook æœƒåœ¨**ä»»ä½•**æª”æ¡ˆè¢«ç·¨è¼¯å¾Œè§¸ç™¼ã€‚å¦‚æœæˆ‘å€‘åªæƒ³åœ¨ç‰¹å®šå·¥å…·è¢«ä½¿ç”¨æ™‚è§¸ç™¼å‘¢ï¼Ÿé€™æ™‚å°±éœ€è¦ä½¿ç”¨ã€ŒåŒ¹é…å™¨ã€ã€‚

1.  å†æ¬¡åŸ·è¡Œ `/hooks`ï¼Œé¸æ“‡ `PostToolUse` äº‹ä»¶ã€‚
2.  é¸æ“‡ `+ Add new matcherâ€¦`ï¼Œè¼¸å…¥ `Bash`ã€‚é€™æ¨£ Hook å°±åªæœƒåœ¨ Claude åŸ·è¡Œ shell å‘½ä»¤å¾Œè§¸ç™¼ã€‚
3.  æ–°å¢ä¸€å€‹ Hook å‘½ä»¤ï¼š
    ```bash
    echo "Claude ran a bash command at $(date)" >> ~/.claude/bash-log.txt
    ```
4.  å„²å­˜è¨­å®šä¸¦é€€å‡ºã€‚

**é©—è­‰ä¸€ä¸‹**ï¼š
*   è«‹ Claude åŸ·è¡Œä¸€å€‹ shell å‘½ä»¤ï¼Œä¾‹å¦‚ã€Œåˆ—å‡ºç›®å‰ç›®éŒ„çš„æª”æ¡ˆã€ã€‚æª¢æŸ¥ `~/.claude/bash-log.txt`ï¼Œæ‚¨æœƒç™¼ç¾æ–°å¢äº†ä¸€æ¢æ—¥èªŒã€‚
*   å†è«‹ Claude ç·¨è¼¯ä¸€å€‹æª”æ¡ˆã€‚é€™æ¬¡åªæœƒåœ¨ `file-edit-log.txt` ä¸­çœ‹åˆ°è¨˜éŒ„ï¼Œè€Œä¸æœƒåœ¨ `bash-log.txt` ä¸­çœ‹åˆ°ã€‚

åŒ¹é…å™¨è®“æ‚¨å¯ä»¥ç²¾æº–æ§åˆ¶ Hook çš„è§¸ç™¼æ™‚æ©Ÿèˆ‡å°è±¡ã€‚

### æ­¥é©Ÿ 3ï¼šèˆ‡ Claude äº’å‹• - è¨˜éŒ„åŸ·è¡Œçš„å‘½ä»¤

ç¾åœ¨ï¼Œæˆ‘å€‘ä¾†æŒ‘æˆ°ä¸€å€‹æ›´é€²éšçš„ Hookï¼šè¨˜éŒ„ Claude å˜—è©¦åŸ·è¡Œçš„æ‰€æœ‰ shell å‘½ä»¤è©³ç´°è³‡è¨Šã€‚é€™å€‹ Hook æœƒè®€å– Claude å‚³éçš„è³‡æ–™ï¼Œä¸¦éœ€è¦ `jq` å·¥å…·ä¾†è§£æ JSONã€‚

**å…ˆæ±ºæ¢ä»¶**ï¼šè«‹ç¢ºä¿æ‚¨å·²å®‰è£ `jq`ã€‚å¦‚æœæ²’æœ‰ï¼Œè«‹ä½¿ç”¨æ‚¨çš„å¥—ä»¶ç®¡ç†å™¨å®‰è£ï¼š
- macOS: `brew install jq`
- Ubuntu/Debian: `sudo apt-get install jq`
- Windows: ä¸‹è¼‰è‡ª https://stedolan.github.io/jq/

1.  åŸ·è¡Œ `/hooks`ï¼Œé€™æ¬¡é¸æ“‡ `PreToolUse` äº‹ä»¶ã€‚é€™å€‹äº‹ä»¶åœ¨ Claude **æº–å‚™**åŸ·è¡Œä¸€å€‹å·¥å…·ï¼ˆå¦‚ `bash` å‘½ä»¤ï¼‰**ä¹‹å‰**è§¸ç™¼ã€‚
2.  ç‚ºé€™å€‹ Hook æ–°å¢ä¸€å€‹åŒ¹é…å™¨ï¼Œè¼¸å…¥ `Bash`ï¼Œé€™æ¨£å®ƒå°±åªæœƒç›£æ§ shell å‘½ä»¤ã€‚
3.  é¸æ“‡ `+ Add new hookâ€¦` ä¸¦è¼¸å…¥ä»¥ä¸‹å‘½ä»¤ï¼š
    ```bash
    jq -r '"COMMAND: \(.tool_input.command) | DESCRIPTION: \(.tool_input.description // "None")"' >> ~/.claude/bash-command-log.txt
    ```
    é€™å€‹å‘½ä»¤æœƒå¾å‚³å…¥çš„ JSON è³‡æ–™ä¸­æå– `command` å’Œ `description` æ¬„ä½ï¼Œä¸¦å°‡å…¶æ ¼å¼åŒ–å¾Œå¯«å…¥æ—¥èªŒæª”ã€‚
4.  å„²å­˜ç‚º `User settings` ä¸¦é€€å‡ºã€‚

**é©—è­‰ä¸€ä¸‹**ï¼šè«‹ Claude åŸ·è¡Œä¸€å€‹ shell å‘½ä»¤ï¼Œä¾‹å¦‚ã€Œåˆ—å‡ºç›®å‰ç›®éŒ„çš„æ‰€æœ‰æª”æ¡ˆã€ã€‚åœ¨æ‚¨æˆæ¬Š Claude åŸ·è¡Œä¹‹å‰ï¼Œé€™å€‹ Hook å°±å·²ç¶“è¢«è§¸ç™¼äº†ã€‚æª¢æŸ¥æ—¥èªŒæª”ï¼š

```bash
cat ~/.claude/bash-command-log.txt
```

æ‚¨æ‡‰è©²æœƒçœ‹åˆ°é¡ä¼¼ `COMMAND: ls -l | DESCRIPTION: List all files in the current directory` çš„è¨˜éŒ„ã€‚

é€éé€™å€‹æ•™å­¸ï¼Œæ‚¨å·²ç¶“å­¸æœƒäº†ï¼š
*   å¦‚ä½•åœ¨ç‰¹å®šäº‹ä»¶ä¸Šå»ºç«‹ Hook
*   å¦‚ä½•ä½¿ç”¨åŒ¹é…å™¨ä¾†éæ¿¾äº‹ä»¶
*   å¦‚ä½•è®€å– Claude å‚³éçš„ä¸Šä¸‹æ–‡è³‡æ–™

## æ ¸å¿ƒæ¦‚å¿µ

### Hook äº‹ä»¶ç”Ÿå‘½é€±æœŸ

Hooks å¯ä»¥åœ¨ Claude Code ç”Ÿå‘½é€±æœŸçš„å¤šå€‹æ™‚é–“é»è§¸ç™¼ã€‚ä»¥ä¸‹æ˜¯ä¸»è¦çš„äº‹ä»¶é¡å‹ï¼š

| äº‹ä»¶åç¨± | è§¸ç™¼æ™‚æ©Ÿ | å¸¸è¦‹ç”¨é€” | å¯é˜»æ­¢æ“ä½œ |
|----------|----------|----------|------------|
| `UserPromptSubmit` | ä½¿ç”¨è€…æäº¤æç¤ºå¾Œï¼ŒClaude è™•ç†**ä¹‹å‰** | é©—è­‰æç¤ºã€æ ¹æ“šæç¤ºå…§å®¹æ³¨å…¥é¡å¤–ä¸Šä¸‹æ–‡ | âœ… æ˜¯ |
| `PreToolUse` | åœ¨å·¥å…·ï¼ˆå¦‚ `Bash`ï¼‰è¢«åŸ·è¡Œ**ä¹‹å‰** | é˜»æ­¢å±éšªå‘½ä»¤ã€è¨˜éŒ„æ„åœ–ã€ä¿®æ”¹å‘½ä»¤ | âœ… æ˜¯ |
| `PostToolUse` | åœ¨å·¥å…·åŸ·è¡Œ**ä¹‹å¾Œ** | è¨˜éŒ„åŸ·è¡Œçµæœã€åŸºæ–¼çµæœè§¸ç™¼ä¸‹ä¸€æ­¥ | âŒ å¦ |
| `Notification` | ç•¶éœ€è¦ç™¼é€é€šçŸ¥æ™‚ | è‡ªè¨‚é€šçŸ¥æ–¹å¼ã€è²éŸ³æé†’ | âŒ å¦ |
| `Stop` | ç•¶ Claude å®Œæˆä»»å‹™æˆ–é‡åˆ°éŒ¯èª¤æ™‚ | æ¸…ç†å·¥ä½œã€å¾ŒçºŒè™•ç† | âœ… æ˜¯ |
| `SubagentStop` | ç•¶å­ä»£ç†ï¼ˆTask å·¥å…·ï¼‰å®Œæˆæ™‚ | é‡å°å­ä»»å‹™çš„å¾ŒçºŒè™•ç† | âœ… æ˜¯ |
| `PreCompact` | åœ¨ Claude åŸ·è¡Œä¸Šä¸‹æ–‡å£“ç¸®**ä¹‹å‰** | æ ¹æ“šå£“ç¸®é¡å‹åŸ·è¡Œä¸åŒæ“ä½œã€å‚™ä»½é‡è¦ä¸Šä¸‹æ–‡ | âŒ å¦ |

### Hook çš„è¼¸å…¥ (stdin)

æ¯å€‹ Hook åœ¨åŸ·è¡Œæ™‚ï¼Œéƒ½æœƒé€éæ¨™æº–è¼¸å…¥ï¼ˆ`stdin`ï¼‰æ¥æ”¶ä¸€å€‹åŒ…å«ä¸Šä¸‹æ–‡è³‡è¨Šçš„ JSON ç‰©ä»¶ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ `jq` æˆ–å…¶ä»–å·¥å…·ä¾†è§£æå®ƒã€‚

**é€šç”¨æ¬„ä½:**
```json
{
  "session_id": "string",
  "transcript_path": "string", // å°è©±è¨˜éŒ„æª”è·¯å¾‘
  "cwd": "string",             // Hook è¢«èª¿ç”¨æ™‚çš„ç•¶å‰å·¥ä½œç›®éŒ„
  "hook_event_name": "string"  // è§¸ç™¼çš„ Hook äº‹ä»¶åç¨±
}
```

**`PreToolUse` çš„è¼¸å…¥ç¯„ä¾‹:**
```json
{
  "session_id": "abc123",
  "transcript_path": "~/.claude/projects/.../session.jsonl",
  "cwd": "/path/to/project",
  "hook_event_name": "PreToolUse",
  "tool_name": "Bash",
  "tool_input": {
    "command": "ls -a",
    "description": "List all files, including hidden ones."
  }
}
```

**`PostToolUse` çš„è¼¸å…¥ç¯„ä¾‹:**
```json
{
  "session_id": "abc123",
  "transcript_path": "~/.claude/projects/.../session.jsonl",
  "cwd": "/path/to/project",
  "hook_event_name": "PostToolUse",
  "tool_name": "Write",
  "tool_input": {
    "file_path": "/path/to/file.ts",
    "content": "console.log('Hello World');"
  },
  "tool_response": {
    "filePath": "/path/to/file.ts",
    "success": true
  }
}
```

**`Notification` çš„è¼¸å…¥ç¯„ä¾‹:**
```json
{
  "session_id": "abc123",
  "transcript_path": "~/.claude/projects/.../session.jsonl",
  "cwd": "/path/to/project",
  "hook_event_name": "Notification",
  "message": "Claude needs your permission to use Bash"
}
```

**`UserPromptSubmit` çš„è¼¸å…¥ç¯„ä¾‹:**
```json
{
  "session_id": "abc123",
  "transcript_path": "~/.claude/projects/.../session.jsonl",
  "cwd": "/path/to/project",
  "hook_event_name": "UserPromptSubmit",
  "prompt": "Write a function to calculate the factorial of a number"
}
```

**`Stop` / `SubagentStop` çš„è¼¸å…¥ç¯„ä¾‹:**
```json
{
  "session_id": "abc123",
  "transcript_path": "~/.claude/projects/.../session.jsonl",
  "cwd": "/path/to/project",
  "hook_event_name": "Stop",
  "stop_hook_active": true
}
```
> `stop_hook_active` ç‚º `true` è¡¨ç¤º Claude æ­£åœ¨å› ç‚ºå‰ä¸€å€‹ `Stop` Hook çš„çµæœè€Œç¹¼çºŒåŸ·è¡Œã€‚æ‚¨å¯ä»¥æª¢æŸ¥æ­¤å€¼ä»¥é¿å…ç„¡é™å¾ªç’°ã€‚

**`PreCompact` çš„è¼¸å…¥ç¯„ä¾‹:**
```json
{
  "session_id": "abc123",
  "transcript_path": "~/.claude/projects/.../session.jsonl",
  "cwd": "/path/to/project",
  "hook_event_name": "PreCompact",
  "trigger": "manual",
  "custom_instructions": ""
}
```
> - `trigger`: å£“ç¸®è§¸ç™¼åŸå› 
>   - `"manual"`: ç”±ä½¿ç”¨è€…é€é `/compact` å‘½ä»¤æ‰‹å‹•è§¸ç™¼
>   - `"auto"`: ç”±æ–¼ä¸Šä¸‹æ–‡è¦–çª—å·²æ»¿è€Œè‡ªå‹•è§¸ç™¼
> - `custom_instructions`: å°æ–¼ `manual` è§¸ç™¼ï¼ŒåŒ…å«ä½¿ç”¨è€…å‚³éçµ¦ `/compact` çš„è‡ªè¨‚æŒ‡ä»¤ï¼›å°æ–¼ `auto` è§¸ç™¼ï¼Œæ­¤æ¬„ä½ç‚ºç©ºå­—ä¸²

### Hook çš„è¼¸å‡ºèˆ‡æ§åˆ¶

Hook å¯ä»¥é€éå…©ç¨®æ–¹å¼å½±éŸ¿ Claude Code çš„è¡Œç‚ºï¼š**ç°¡å–®çš„é€€å‡ºç¢¼**æˆ–**é€²éšçš„ JSON è¼¸å‡º**ã€‚è¼¸å‡ºä¸»è¦ç”¨ä¾†æºé€šæ˜¯å¦è¦é˜»æ­¢æ“ä½œï¼Œä»¥åŠæ‡‰è©²å‘ Claude å’Œä½¿ç”¨è€…é¡¯ç¤ºä»€éº¼å›é¥‹ã€‚

#### 1. ç°¡å–®æ§åˆ¶ï¼šé€€å‡ºä»£ç¢¼ (Exit Code)

é€™æ˜¯æœ€åŸºæœ¬çš„å›é¥‹æ©Ÿåˆ¶ã€‚
- **é€€å‡ºä»£ç¢¼ 0**: æˆåŠŸã€‚`stdout` çš„å…§å®¹æœƒä»¥ä¸€èˆ¬è³‡è¨Šçš„å½¢å¼é¡¯ç¤ºçµ¦ä½¿ç”¨è€…ï¼ˆåœ¨ transcript æ¨¡å¼ä¸‹å¯è¦‹ï¼‰ï¼Œä½† Claude **ä¸æœƒ**çœ‹åˆ°ã€‚
- **é€€å‡ºä»£ç¢¼ 2**: é˜»æ“‹æ€§éŒ¯èª¤ã€‚`stderr` çš„å…§å®¹æœƒä½œç‚ºå›é¥‹**æä¾›çµ¦ Claude** é€²è¡Œè™•ç†ã€‚ä¸åŒäº‹ä»¶çš„å…·é«”è¡Œç‚ºä¸åŒï¼ˆè¦‹ä¸‹è¡¨ï¼‰ã€‚
- **å…¶ä»–é€€å‡ºä»£ç¢¼**: éé˜»æ“‹æ€§éŒ¯èª¤ã€‚`stderr` çš„å…§å®¹åªæœƒé¡¯ç¤ºçµ¦ä½¿ç”¨è€…ï¼Œæ“ä½œæœƒç¹¼çºŒåŸ·è¡Œã€‚

**é€€å‡ºä»£ç¢¼ 2 çš„è¡Œç‚ºç´°ç¯€**

| Hook äº‹ä»¶ | é˜»æ“‹è¡Œç‚º |
| ------------------ | ------------------------------------------------------------------ |
| `PreToolUse` | é˜»æ“‹å·¥å…·åŸ·è¡Œï¼Œä¸¦å°‡ `stderr` å…§å®¹äº¤çµ¦ Claude åˆ†æã€‚ |
| `PostToolUse` | å·¥å…·å·²ç¶“åŸ·è¡Œï¼Œä½†æœƒå°‡ `stderr` å…§å®¹äº¤çµ¦ Claude é€²è¡Œå¾ŒçºŒä¿®æ­£ã€‚ |
| `UserPromptSubmit` | é˜»æ“‹ä½¿ç”¨è€…æç¤ºçš„è™•ç†ï¼Œæ¸…é™¤è©²æç¤ºï¼Œä¸¦å°‡ `stderr` é¡¯ç¤ºçµ¦ä½¿ç”¨è€…ã€‚ |
| `Stop` / `SubagentStop` | é˜»æ“‹ Claude åœæ­¢ï¼Œä¸¦å°‡ `stderr` å…§å®¹äº¤çµ¦ Claude ä»¥æ±ºå®šä¸‹ä¸€æ­¥ã€‚ |
| `Notification` / `PreCompact` | ç„¡ç‰¹æ®Šé˜»æ“‹æ•ˆæœï¼Œåƒ…å°‡ `stderr` é¡¯ç¤ºçµ¦ä½¿ç”¨è€…ã€‚ |


âš ï¸ **é‡è¦æé†’**: ç•¶é€€å‡ºä»£ç¢¼ç‚º 0 æ™‚ï¼ŒClaude **ä¸æœƒçœ‹åˆ°** `stdout` çš„å…§å®¹ã€‚åªæœ‰ `stderr` åœ¨é€€å‡ºä»£ç¢¼ç‚º 2 æ™‚æ‰æœƒè¢« Claude è™•ç†ã€‚

#### 2. é€²éšæ§åˆ¶ï¼šJSON è¼¸å‡º

ç‚ºäº†é€²è¡Œæ›´ç²¾ç´°çš„æ§åˆ¶ï¼ŒHook å¯ä»¥é€é `stdout` è¿”å›ä¸€å€‹ JSON ç‰©ä»¶ã€‚

**é€šç”¨ JSON æ¬„ä½ (é©ç”¨æ–¼æ‰€æœ‰äº‹ä»¶):**
```json
{
  "continue": true,
  "stopReason": "ä½¿ç”¨è€…è¦æ±‚çš„æ“ä½œå·²çµ‚æ­¢",
  "suppressOutput": true
}
```
- `continue` (`boolean`, é è¨­ `true`): è¨­ç‚º `false` å¯åœ¨ Hook åŸ·è¡Œå¾Œå®Œå…¨çµ‚æ­¢ Claude çš„å¾ŒçºŒè™•ç†ã€‚
- `stopReason` (`string`): ç•¶ `continue` ç‚º `false` æ™‚ï¼Œå‘ä½¿ç”¨è€…é¡¯ç¤ºçš„åœæ­¢åŸå› ï¼ˆ**ä¸æœƒ**é¡¯ç¤ºçµ¦ Claudeï¼‰ã€‚
- `suppressOutput` (`boolean`, é è¨­ `false`): è¨­ç‚º `true` å¯ä»¥éš±è— Hook çš„ `stdout`ï¼Œä½¿å…¶ä¸åœ¨ transcript æ¨¡å¼ä¸­é¡¯ç¤ºã€‚

**é‡è¦è¡Œç‚ºèªªæ˜:**
- ç•¶ `continue` ç‚º `false` æ™‚ï¼Œæœƒå„ªå…ˆæ–¼ä»»ä½• `"decision": "block"` è¨­å®š
- å°æ–¼ `PreToolUse`ï¼Œé€™èˆ‡ `"decision": "block"` ä¸åŒ - å¾Œè€…åªé˜»æ“‹ç‰¹å®šå·¥å…·å‘¼å«ä¸¦æä¾›è‡ªå‹•å›é¥‹çµ¦ Claude
- å°æ–¼ `PostToolUse`ï¼Œé€™èˆ‡ `"decision": "block"` ä¸åŒ - å¾Œè€…æä¾›è‡ªå‹•å›é¥‹çµ¦ Claude
- å°æ–¼ `UserPromptSubmit`ï¼Œé€™æœƒé˜»æ­¢æç¤ºè¢«è™•ç†
- å°æ–¼ `Stop` å’Œ `SubagentStop`ï¼Œé€™æœƒå„ªå…ˆæ–¼ä»»ä½• `"decision": "block"` è¼¸å‡º

**ç‰¹å®šäº‹ä»¶çš„æ±ºç­–æ§åˆ¶ (`decision`):**

- **`PreToolUse`**: æ§åˆ¶å·¥å…·æ˜¯å¦åŸ·è¡Œã€‚
  ```json
  {
    "decision": "approve" | "block",
    "reason": "æ‰¹å‡†åŸå› æˆ–é˜»æ“‹åŸå› "
  }
  ```
  - `"approve"`: ç¹éæ¬Šé™è©¢å•ï¼Œç›´æ¥åŸ·è¡Œã€‚`reason` é¡¯ç¤ºçµ¦ä½¿ç”¨è€…ã€‚
  - `"block"`: é˜»æ­¢å·¥å…·åŸ·è¡Œã€‚`reason` æœƒ**æä¾›çµ¦ Claude**ã€‚
  - `undefined`: ä¿æŒé è¨­çš„æ¬Šé™è©¢å•æµç¨‹ã€‚

- **`PostToolUse` / `Stop` / `SubagentStop`**: æ§åˆ¶æ˜¯å¦éœ€è¦ Claude é€²è¡Œå¾ŒçºŒè™•ç†ã€‚
  ```json

  {
    "decision": "block",
    "reason": "éœ€è¦ Claude è™•ç†çš„å›é¥‹è³‡è¨Š"
  }
  ```
  - `"block"`: æç¤º Claude æ ¹æ“š `reason` ç¹¼çºŒå·¥ä½œã€‚ä¾‹å¦‚ï¼Œåœ¨ `PostToolUse` ä¸­æŒ‡å‡ºç¨‹å¼ç¢¼æ ¼å¼å•é¡Œï¼Œæˆ–åœ¨ `Stop` ä¸­è¦æ±‚ Claude ç¹¼çºŒåŸ·è¡Œä¸‹ä¸€æ­¥ã€‚

- **`UserPromptSubmit`**: æ§åˆ¶ä½¿ç”¨è€…æç¤ºæ˜¯å¦è¢«è™•ç†ã€‚
  ```json
  {
    "decision": "block",
    "reason": "å‘ä½¿ç”¨è€…é¡¯ç¤ºçš„é˜»æ“‹åŸå› "
  }
  ```
  - `"block"`: é˜»æ­¢æç¤ºè¢«è™•ç†ï¼Œä¸¦æ¸…é™¤è©²æç¤ºã€‚`reason` åªæœƒé¡¯ç¤ºçµ¦ä½¿ç”¨è€…ã€‚

### è¨­å®šæª”ä½ç½®

Claude Code çš„è¨­å®šæª”çµæ§‹å¦‚ä¸‹ï¼Œæ‚¨å¯ä»¥å°‡ Hooks è¨­å®šæ”¾åœ¨å…¶ä¸­ï¼š

```json
{
  "hooks": {
    "EventName": [
      {
        "matcher": "ToolPattern",
        "hooks": [
          {
            "type": "command",
            "command": "your-command-here",
            "timeout": 30
          }
        ]
      }
    ]
  }
}
```
- `matcher`: å·¥å…·åç¨±æ¨¡å¼åŒ¹é…ï¼ˆä¾‹å¦‚ `Edit|Write`ï¼‰ï¼Œæ”¯æ´ç°¡å–®å­—ä¸²ç²¾ç¢ºåŒ¹é…å’Œæ­£è¦è¡¨ç¤ºå¼ï¼Œå°å¤§å°å¯«æ•æ„Ÿã€‚å¦‚æœçœç•¥æˆ–ç‚ºç©ºå­—ä¸²ï¼Œå‰‡æœƒå°æ‰€æœ‰å·¥å…·ç”Ÿæ•ˆã€‚
- `hooks`: ä¸€çµ„è¦åŸ·è¡Œçš„å‘½ä»¤ã€‚
- `command`: è¦åŸ·è¡Œçš„ shell å‘½ä»¤ã€‚
- `timeout` (å¯é¸): å‘½ä»¤åŸ·è¡Œçš„è¶…æ™‚æ™‚é–“ï¼ˆç§’ï¼‰ã€‚

**è¨­å®šæª”å±¤ç´š:**

*   **ä½¿ç”¨è€…è¨­å®š** (`~/.claude/settings.json`): åœ¨é€™è£¡è¨­å®šçš„ Hooks æœƒåœ¨æ‚¨æ‰€æœ‰çš„å°ˆæ¡ˆä¸­ç”Ÿæ•ˆã€‚é©åˆé€šç”¨è¦å‰‡ï¼Œå¦‚é€šçŸ¥ã€æ—¥èªŒè¨˜éŒ„ã€‚
*   **å°ˆæ¡ˆè¨­å®š** (`<project_root>/.claude/settings.json`): åœ¨é€™è£¡è¨­å®šçš„ Hooks **åƒ…**å°ç•¶å‰å°ˆæ¡ˆç”Ÿæ•ˆã€‚é©åˆå°ˆæ¡ˆç‰¹å®šçš„è¦å‰‡ï¼Œå¦‚ç¨‹å¼ç¢¼æ ¼å¼åŒ–ã€ç‰¹å®šæ–¼å°ˆæ¡ˆçš„å®‰å…¨é˜²è­·ã€‚
*   **æœ¬åœ°å°ˆæ¡ˆè¨­å®š** (`<project_root>/.claude/settings.local.json`): æœ¬åœ°è¨­å®šï¼Œä¸æœƒè¢«ç‰ˆæœ¬æ§åˆ¶ã€‚
*   **ä¼æ¥­ç®¡ç†æ”¿ç­–è¨­å®š**: å¦‚æœæ‚¨åœ¨ä¼æ¥­ç’°å¢ƒä¸­ï¼Œç®¡ç†å“¡å¯èƒ½å·²é…ç½®å…¨åŸŸç­–ç•¥è¨­å®šã€‚


âš ï¸ **é‡è¦æé†’**: `"matcher": "*"` æ˜¯ç„¡æ•ˆçš„èªæ³•ã€‚å¦‚æœè¦åŒ¹é…æ‰€æœ‰å·¥å…·ï¼Œè«‹çœç•¥ `matcher` æ¬„ä½æˆ–ä½¿ç”¨ `"matcher": ""`ã€‚

## å¯¦ç”¨ç¯„ä¾‹åº«

é€™è£¡æœ‰ä¸€äº›å¯ä»¥ç›´æ¥ä½¿ç”¨çš„ç¯„ä¾‹ï¼Œå¹«åŠ©æ‚¨å¿«é€Ÿæå‡æ•ˆç‡ã€‚

### 1. ç¨‹å¼ç¢¼è‡ªå‹•æ ¼å¼åŒ–

#### TypeScript/JavaScript (Prettier)

åœ¨ Claude æ¯æ¬¡ä¿®æ”¹å®Œæª”æ¡ˆå¾Œï¼Œè‡ªå‹•åŸ·è¡Œ Prettier æ ¼å¼åŒ–ã€‚

**è¨­å®š:**
- **äº‹ä»¶**: `PostToolUse`
- **åŒ¹é…å™¨**: `Edit|MultiEdit|Write`
- **Hook å‘½ä»¤**:
```bash
# æª¢æŸ¥æ˜¯å¦ç‚º JS/TS æª”æ¡ˆä¸¦åŸ·è¡Œ prettier
file_path=$(jq -r '.tool_input.file_path // ""')
if [[ "$file_path" =~ \.(js|jsx|ts|tsx)$ ]] && [[ -f "$file_path" ]] && [[ -f "package.json" ]]; then
    npx --no-install prettier --write "$file_path"
    echo "âœ¨ å·²è‡ªå‹•æ ¼å¼åŒ–æª”æ¡ˆ: $file_path"
fi
```

#### Go ç¨‹å¼ç¢¼æ ¼å¼åŒ–

**è¨­å®š:**
- **äº‹ä»¶**: `PostToolUse`
- **åŒ¹é…å™¨**: `Edit|MultiEdit|Write`
- **Hook å‘½ä»¤**:
```bash
# æª¢æŸ¥æ˜¯å¦ç‚º Go æª”æ¡ˆä¸¦åŸ·è¡Œ gofmt
file_path=$(jq -r '.tool_input.file_path // ""')
if [[ "$file_path" =~ \.go$ ]] && [[ -f "$file_path" ]]; then
    gofmt -w "$file_path"
    echo "âœ¨ å·²è‡ªå‹•æ ¼å¼åŒ– Go æª”æ¡ˆ: $file_path"
fi
```

### 2. é€²éšï¼šä½¿ç”¨ Python è…³æœ¬é€²è¡Œæ™ºæ…§é©—è­‰

é€™å€‹ç¯„ä¾‹å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ Python è…³æœ¬ï¼Œåœ¨ Claude åŸ·è¡Œ `Bash` å‘½ä»¤å‰é€²è¡Œé©—è­‰ï¼Œä¸¦ä½¿ç”¨ **JSON è¼¸å‡º** æä¾›çµæ§‹åŒ–çš„å›é¥‹ã€‚

**è¨­å®š:**
- **äº‹ä»¶**: `PreToolUse`
- **åŒ¹é…å™¨**: `Bash`
- **Hook å‘½ä»¤**: `python .claude/hooks/validate_bash.py`

**å»ºç«‹è…³æœ¬ (`.claude/hooks/validate_bash.py`):**
```python
#!/usr/bin/env python3
import json
import re
import sys

# å®šç¾©é©—è­‰è¦å‰‡ (æ­£è¦è¡¨ç¤ºå¼, å»ºè­°è¨Šæ¯)
VALIDATION_RULES = [
    (
        r"\bgrep\b(?!.*\|)",
        "è«‹æ”¹ç”¨ 'rg' (ripgrep)ï¼Œå®ƒåœ¨å°ˆæ¡ˆç¯„åœå…§çš„æœå°‹æ•ˆèƒ½æ›´å¥½ã€‚",
    ),
    (
        r"\bfind\s+\S+\s+-name\b",
        "å»ºè­°ä½¿ç”¨ 'rg --files | rg <pattern>' æˆ– 'rg -g '<pattern>'' ä¾†å–ä»£ 'find -name'ï¼Œé€Ÿåº¦æ›´å¿«ã€‚",
    ),
]

def validate_command(command: str) -> list[str]:
    issues = []
    for pattern, message in VALIDATION_RULES:
        if re.search(pattern, command):
            issues.append(message)
    return issues

try:
    input_data = json.load(sys.stdin)
except json.JSONDecodeError:
    sys.exit(1) # ç„¡æ³•è§£æ JSONï¼Œéœé»˜é€€å‡º

command = input_data.get("tool_input", {}).get("command", "")
if not command:
    sys.exit(0) # å¦‚æœæ²’æœ‰å‘½ä»¤ï¼Œå‰‡ä¸é€²è¡Œä»»ä½•æ“ä½œ

issues = validate_command(command)

if issues:
    # å¦‚æœç™¼ç¾å•é¡Œï¼Œä½¿ç”¨ JSON è¼¸å‡ºæ ¼å¼ä¾†é˜»æ“‹ä¸¦æä¾›å›é¥‹
    response = {
        "decision": "block",
        "reason": "ç™¼ç¾ä»¥ä¸‹å¯ä»¥æ”¹é€²çš„åœ°æ–¹ï¼š\n- " + "\n- ".join(issues)
    }
    print(json.dumps(response))
else:
    # å¦‚æœæ²’æœ‰å•é¡Œï¼Œå¯ä»¥æ˜ç¢ºæ‰¹å‡†æˆ–ä¸è¼¸å‡ºä»»ä½•æ±è¥¿è®“æµç¨‹ç¹¼çºŒ
    print(json.dumps({"decision": "approve", "reason": "å‘½ä»¤æª¢æŸ¥é€šé"}))

sys.exit(0)
```

### 3. è‡ªè¨‚é€šçŸ¥ç³»çµ±

#### macOS èªéŸ³é€šçŸ¥

ç•¶ Claude ç­‰å¾…æ‚¨æˆæ¬Šæ™‚ï¼Œç™¼å‡ºèªéŸ³æé†’ã€‚

**è¨­å®š:**
- **äº‹ä»¶**: `Notification`
- **åŒ¹é…å™¨**: (ç•™ç©ºï¼Œé©ç”¨æ–¼æ‰€æœ‰é€šçŸ¥)
- **Hook å‘½ä»¤**:
```bash
message=$(jq -r '.message // "Claude Code notification"')
say "Claude says: $message"
```

#### Linux æ¡Œé¢é€šçŸ¥

**è¨­å®š:**
- **äº‹ä»¶**: `Notification`
- **åŒ¹é…å™¨**: (ç•™ç©º)
- **Hook å‘½ä»¤**:
```bash
# éœ€è¦å®‰è£ libnotify-bin
title=$(jq -r '.title // "Claude Code"')
message=$(jq -r '.message // "Notification from Claude"')
notify-send "$title" "$message"
```

### 4. å®‰å…¨é˜²è­·ç¯„ä¾‹

#### é˜²æ­¢å±éšªå‘½ä»¤åŸ·è¡Œ

é˜»æ­¢ Claude åŸ·è¡Œå¯èƒ½å±éšªçš„å‘½ä»¤ã€‚

**è¨­å®š:**
- **äº‹ä»¶**: `PreToolUse`
- **åŒ¹é…å™¨**: `Bash`
- **Hook å‘½ä»¤**:
```bash
command=$(jq -r '.tool_input.command // ""')

# æª¢æŸ¥å±éšªå‘½ä»¤æ¨¡å¼
dangerous_patterns=("rm -rf" "sudo rm" "dd if=" "mkfs" "fdisk" "> /dev/")

for pattern in "${dangerous_patterns[@]}"; do
    if [[ "$command" == *"$pattern"* ]]; then
        # ä½¿ç”¨é€€å‡ºç¢¼ 2 ä¾†é˜»æ“‹æ“ä½œï¼Œä¸¦å°‡ stderr çš„å…§å®¹å‚³éçµ¦ Claude
        echo "ğŸš« å®‰å…¨è­¦å‘Š: å·²é˜»æ­¢æ½›åœ¨å±éšªå‘½ä»¤: $command" >&2
        echo "ğŸ’¡ å»ºè­°: è«‹ä½¿ç”¨æ›´å®‰å…¨çš„æ›¿ä»£æ–¹æ¡ˆæˆ–æ˜ç¢ºæŒ‡å®šæª”æ¡ˆ" >&2
        exit 2
    fi
done

echo "âœ… å‘½ä»¤å®‰å…¨æª¢æŸ¥é€šé: $command"
```

#### ä¿è­·æ•æ„Ÿæª”æ¡ˆ

é˜²æ­¢ Claude ä¿®æ”¹é‡è¦çš„è¨­å®šæª”æ¡ˆã€‚

**è¨­å®š:**
- **äº‹ä»¶**: `PreToolUse`
- **åŒ¹é…å™¨**: `Edit|MultiEdit|Write`
- **Hook å‘½ä»¤**:
```bash
file_path=$(jq -r '.tool_input.file_path // ""')

# æ•æ„Ÿæª”æ¡ˆæ¨¡å¼
sensitive_files=(".env" ".env.local" ".env.production" "id_rsa" "id_ed25519" "package-lock.json" "yarn.lock")

for pattern in "${sensitive_files[@]}"; do
    if [[ "$file_path" == *"$pattern"* ]]; then
        reason=""
        case "$pattern" in
            "package-lock.json"|"yarn.lock")
                reason="ğŸ’¡ æç¤º: å¦‚éœ€æ›´æ–°ä¾è³´ï¼Œè«‹è®“ Claude ä½¿ç”¨ 'npm install' æˆ– 'yarn install'"
                ;;
            ".env"*)
                reason="ğŸ’¡ æç¤º: ç’°å¢ƒè®Šæ•¸æª”æ¡ˆåŒ…å«æ•æ„Ÿè³‡è¨Šï¼Œè«‹æ‰‹å‹•ç·¨è¼¯"
                ;;
            "id_rsa"|"id_ed25519")
                reason="ğŸ’¡ æç¤º: SSH é‡‘é‘°æª”æ¡ˆä¸æ‡‰è¢« Claude ä¿®æ”¹"
                ;;
            *)
                reason="ğŸ”’ å®‰å…¨é™åˆ¶: ä¸å…è¨± Claude ä¿®æ”¹æ•æ„Ÿæª”æ¡ˆ: $file_path"
                ;;
        esac
        # ä½¿ç”¨ JSON è¼¸å‡ºé˜»æ“‹æ“ä½œ
        jq -n --arg reason "$reason" '{decision: "block", reason: $reason}'
        exit 0
    fi
done
```

### 5. è‡ªå‹•æ¸¬è©¦åŸ·è¡Œ

åœ¨ç¨‹å¼ç¢¼ä¿®æ”¹å¾Œè‡ªå‹•åŸ·è¡Œæ¸¬è©¦ã€‚

**è¨­å®š:**
- **äº‹ä»¶**: `PostToolUse`
- **åŒ¹é…å™¨**: `Edit|MultiEdit|Write`
- **Hook å‘½ä»¤**:
```bash
file_path=$(jq -r '.tool_input.file_path // ""')

# æª¢æŸ¥æ˜¯å¦ç‚ºæ¸¬è©¦ç›¸é—œæª”æ¡ˆæˆ–æºç¢¼æª”æ¡ˆ
if [[ "$file_path" =~ \.(test|spec)\. ]] || [[ "$file_path" =~ /src/ ]]; then
    echo "ğŸ§ª æª¢æ¸¬åˆ°ç¨‹å¼ç¢¼è®Šæ›´ï¼ŒåŸ·è¡Œç›¸é—œæ¸¬è©¦..."
    
    # æª¢æŸ¥å°ˆæ¡ˆé¡å‹ä¸¦åŸ·è¡Œé©ç•¶çš„æ¸¬è©¦å‘½ä»¤
    if [ -f "package.json" ]; then
        # --no-install é¿å…åœ¨æ²’æœ‰ node_modules æ™‚çš„äº¤äº’æç¤º
        if jq -e '.scripts.test' package.json > /dev/null; then
            npm test -- --testPathPattern="$(basename "$file_path" | sed 's/\.[^.]*$//')"
        fi
    elif [ -f "go.mod" ]; then
        go test ./...
    elif [ -f "Cargo.toml" ]; then
        cargo test
    elif [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
        python -m pytest -xvs
    fi
fi
```

### 5. å®˜æ–¹ç¯„ä¾‹ï¼šBash å‘½ä»¤é©—è­‰

ä»¥ä¸‹æ˜¯å®˜æ–¹æä¾›çš„ Python è…³æœ¬ç¯„ä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨ JSON è¼¸å‡ºé€²è¡Œ Bash å‘½ä»¤é©—è­‰ï¼š

**è¨­å®š:**
- **äº‹ä»¶**: `PreToolUse`
- **åŒ¹é…å™¨**: `Bash`
- **Hook å‘½ä»¤**: `python /path/to/bash-validator.py`

**è…³æœ¬å…§å®¹ (`bash-validator.py`):**
```python
#!/usr/bin/env python3
import json
import re
import sys

# å®šç¾©é©—è­‰è¦å‰‡ç‚º (æ­£è¦è¡¨ç¤ºå¼æ¨¡å¼, è¨Šæ¯) çš„å…ƒçµ„åˆ—è¡¨
VALIDATION_RULES = [
    (
        r"\bgrep\b(?!.*\|)",
        "å»ºè­°ä½¿ç”¨ 'rg' (ripgrep) è€Œé 'grep'ï¼Œæ•ˆèƒ½å’ŒåŠŸèƒ½éƒ½æ›´å¥½",
    ),
    (
        r"\bfind\s+\S+\s+-name\b",
        "å»ºè­°ä½¿ç”¨ 'rg --files | rg pattern' æˆ– 'rg --files -g pattern' è€Œé 'find -name'ï¼Œæ•ˆèƒ½æ›´å¥½",
    ),
]

def validate_command(command: str) -> list[str]:
    issues = []
    for pattern, message in VALIDATION_RULES:
        if re.search(pattern, command):
            issues.append(message)
    return issues

try:
    input_data = json.load(sys.stdin)
except json.JSONDecodeError as e:
    print(f"éŒ¯èª¤: ç„¡æ•ˆçš„ JSON è¼¸å…¥: {e}", file=sys.stderr)
    sys.exit(1)

tool_name = input_data.get("tool_name", "")
tool_input = input_data.get("tool_input", {})
command = tool_input.get("command", "")

if tool_name != "Bash" or not command:
    sys.exit(1)

# é©—è­‰å‘½ä»¤
issues = validate_command(command)

if issues:
    for message in issues:
        print(f"â€¢ {message}", file=sys.stderr)
    # é€€å‡ºä»£ç¢¼ 2 é˜»æ“‹å·¥å…·åŸ·è¡Œä¸¦å°‡ stderr å‚³éçµ¦ Claude
    sys.exit(2)
```

### 6. å®˜æ–¹ç¯„ä¾‹ï¼šä½¿ç”¨è€…æç¤ºé©—è­‰èˆ‡ä¸Šä¸‹æ–‡æ·»åŠ 

**è¨­å®š:**
- **äº‹ä»¶**: `UserPromptSubmit`
- **Hook å‘½ä»¤**: `python /path/to/prompt-validator.py`

**è…³æœ¬å…§å®¹ (`prompt-validator.py`):**
```python
#!/usr/bin/env python3
import json
import sys
import re
import datetime

# å¾ stdin è¼‰å…¥è¼¸å…¥
try:
    input_data = json.load(sys.stdin)
except json.JSONDecodeError as e:
    print(f"éŒ¯èª¤: ç„¡æ•ˆçš„ JSON è¼¸å…¥: {e}", file=sys.stderr)
    sys.exit(1)

prompt = input_data.get("prompt", "")

# æª¢æŸ¥æ•æ„Ÿæ¨¡å¼
sensitive_patterns = [
    (r"(?i)\b(password|secret|key|token)\s*[:=]", "æç¤ºåŒ…å«æ½›åœ¨çš„æ©Ÿå¯†è³‡è¨Š"),
]

for pattern, message in sensitive_patterns:
    if re.search(pattern, prompt):
        # ä½¿ç”¨ JSON è¼¸å‡ºé˜»æ“‹ä¸¦æä¾›ç‰¹å®šåŸå› 
        output = {
            "decision": "block",
            "reason": f"å®‰å…¨æ”¿ç­–é•è¦: {message}ã€‚è«‹é‡æ–°è¡¨è¿°æ‚¨çš„è«‹æ±‚ï¼Œä¸è¦åŒ…å«æ•æ„Ÿè³‡è¨Šã€‚"
        }
        print(json.dumps(output))
        sys.exit(0)

# æ·»åŠ ç•¶å‰æ™‚é–“åˆ°ä¸Šä¸‹æ–‡
context = f"ç•¶å‰æ™‚é–“: {datetime.datetime.now()}"
print(context)

# å…è¨±æç¤ºç¹¼çºŒè™•ç†ï¼Œä¸¦åŒ…å«é¡å¤–çš„ä¸Šä¸‹æ–‡
sys.exit(0)
```

### 7. æ™ºæ…§å‚™ä»½ç³»çµ±

åœ¨é‡è¦æª”æ¡ˆè¢«ä¿®æ”¹å‰è‡ªå‹•å»ºç«‹å‚™ä»½ã€‚

**è¨­å®š:**
- **äº‹ä»¶**: `PreToolUse`
- **åŒ¹é…å™¨**: `Edit|MultiEdit|Write`
- **Hook å‘½ä»¤**:
```bash
file_path=$(jq -r '.tool_input.file_path // ""')

# éœ€è¦å‚™ä»½çš„é‡è¦æª”æ¡ˆæ¨¡å¼
important_patterns=("config" "settings" ".json" ".yaml" ".yml" "Dockerfile" "Makefile")

should_backup=false
for pattern in "${important_patterns[@]}"; do
    if [[ "$file_path" == *"$pattern"* ]]; then
        should_backup=true
        break
    fi
done

if [ "$should_backup" = true ] && [ -f "$file_path" ]; then
    backup_dir="$(dirname "$file_path")/.claude-backups"
    mkdir -p "$backup_dir"
    
    timestamp=$(date +"%Y%m%d_%H%M%S")
    backup_file="$backup_dir/$(basename "$file_path").backup.$timestamp"
    
    cp "$file_path" "$backup_file"
    echo "ğŸ’¾ å·²å»ºç«‹å‚™ä»½: $backup_file"
fi
```

## Hook åŸ·è¡Œç´°ç¯€

### åŸ·è¡Œç’°å¢ƒèˆ‡é™åˆ¶

- **åŸ·è¡Œè¶…æ™‚**: é è¨­ 60 ç§’åŸ·è¡Œé™åˆ¶ï¼Œå¯é‡å°å€‹åˆ¥å‘½ä»¤è¨­å®š `timeout` åƒæ•¸
  - å€‹åˆ¥å‘½ä»¤çš„è¶…æ™‚ä¸æœƒå½±éŸ¿å…¶ä»–å‘½ä»¤
- **ä¸¦è¡ŒåŸ·è¡Œ**: æ‰€æœ‰åŒ¹é…çš„ Hooks æœƒä¸¦è¡ŒåŸ·è¡Œ
- **åŸ·è¡Œç’°å¢ƒ**: åœ¨ç•¶å‰ç›®éŒ„ä¸­åŸ·è¡Œï¼Œä½¿ç”¨ Claude Code çš„ç’°å¢ƒè®Šæ•¸
- **è¼¸å…¥æ–¹å¼**: é€é stdin æ¥æ”¶ JSON è³‡æ–™
- **è¼¸å‡ºè™•ç†**:
  - `PreToolUse`/`PostToolUse`/`Stop`: é€²åº¦é¡¯ç¤ºåœ¨ transcript æ¨¡å¼ (Ctrl-R)
  - `Notification`: åƒ…è¨˜éŒ„åœ¨é™¤éŒ¯æ—¥èªŒä¸­ (`--debug`)

### Hook åŒ¹é…è¦å‰‡

**å°æ–¼ `PreToolUse` å’Œ `PostToolUse` äº‹ä»¶:**
- `matcher` æ˜¯å¿…è¦çš„ï¼Œç”¨æ–¼æŒ‡å®šè¦ç›£æ§çš„å·¥å…·
- æ”¯æ´ç²¾ç¢ºå­—ä¸²åŒ¹é…ï¼š`"Write"` åªåŒ¹é… Write å·¥å…·
- æ”¯æ´æ­£è¦è¡¨ç¤ºå¼ï¼š`"Edit|Write"` æˆ– `"Notebook.*"`
- å¤§å°å¯«æ•æ„Ÿ
- å¦‚æœçœç•¥æˆ–ç‚ºç©ºå­—ä¸²ï¼Œå‰‡åŒ¹é…æ‰€æœ‰å·¥å…·

**å°æ–¼å…¶ä»–äº‹ä»¶:**
- `UserPromptSubmit`, `Notification`, `Stop`, `SubagentStop`, `PreCompact` ä¸ä½¿ç”¨ matcher
- å¯ä»¥çœç•¥ `matcher` æ¬„ä½æˆ–å°‡å…¶è¨­ç‚ºç©ºå­—ä¸²

### å¸¸è¦‹å·¥å…·åŒ¹é…å™¨

ä»¥ä¸‹æ˜¯å¯ä»¥åœ¨ `PreToolUse` å’Œ `PostToolUse` ä¸­ä½¿ç”¨çš„å¸¸è¦‹å·¥å…·åç¨±ï¼š

- `Task` - ä»£ç†ä»»å‹™
- `Bash` - Shell å‘½ä»¤
- `Glob` - æª”æ¡ˆæ¨¡å¼åŒ¹é…
- `Grep` - å…§å®¹æœå°‹
- `Read` - æª”æ¡ˆè®€å–
- `Edit`, `MultiEdit` - æª”æ¡ˆç·¨è¼¯
- `Write` - æª”æ¡ˆå¯«å…¥
- `WebFetch`, `WebSearch` - ç¶²è·¯æ“ä½œ

## é€²éšåŠŸèƒ½

### MCP å·¥å…·æ•´åˆ

Claude Code æ”¯æ´ MCP (Model Context Protocol) å·¥å…·ï¼Œæ‚¨ä¹Ÿå¯ä»¥ç‚ºé€™äº›å·¥å…·è¨­å®š Hooksã€‚MCP å·¥å…·éµå¾ª `mcp__<server>__<tool>` çš„å‘½åæ¨¡å¼ã€‚

**ç¯„ä¾‹ï¼šç›£æ§è¨˜æ†¶é«”æ“ä½œ**
```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "mcp__memory__.*",
        "hooks": [
          {
            "type": "command",
            "command": "echo 'Memory operation: ' $(jq -r '.tool_name') >> ~/.claude/memory-log.txt"
          }
        ]
      }
    ]
  }
}
```

### ä½¿ç”¨å¤–éƒ¨è…³æœ¬

å°æ–¼è¤‡é›œçš„é‚è¼¯ï¼Œå»ºè­°å»ºç«‹ç¨ç«‹çš„è…³æœ¬æª”æ¡ˆï¼š

**å»ºç«‹è…³æœ¬æª”æ¡ˆ** (`.claude/hooks/security_check.js`):
```javascript
#!/usr/bin/env node

async function main() {
  const chunks = [];
  for await (const chunk of process.stdin) {
    chunks.push(chunk);
  }

  const toolData = JSON.parse(Buffer.concat(chunks).toString());
  const command = toolData.tool_input?.command || "";
  
  // è¤‡é›œçš„å®‰å…¨æª¢æŸ¥é‚è¼¯
  const dangerousPatterns = [
    /rm\s+-rf\s+\//, // åˆªé™¤æ ¹ç›®éŒ„
    /sudo\s+rm/, // sudo åˆªé™¤
    /chmod\s+777/, // éæ–¼å¯¬é¬†çš„æ¬Šé™
  ];
  
  for (const pattern of dangerousPatterns) {
    if (pattern.test(command)) {
      console.error(`ğŸš« æª¢æ¸¬åˆ°å±éšªå‘½ä»¤æ¨¡å¼: ${command}`);
      process.exit(2);
    }
  }
  
  console.log(`âœ… å®‰å…¨æª¢æŸ¥é€šé`);
  process.exit(0);
}

main().catch(console.error);
```

**åœ¨ Hook ä¸­ä½¿ç”¨è…³æœ¬**:
```bash
# æ–¹å¼ä¸€ï¼šä½¿ç”¨ node å‘½ä»¤åŸ·è¡Œï¼ˆæ¨è–¦ï¼‰
node .claude/hooks/security_check.js

# æ–¹å¼äºŒï¼šç›´æ¥åŸ·è¡Œï¼ˆéœ€è¦ shebang è¡Œå’ŒåŸ·è¡Œæ¬Šé™ï¼‰
# ç¢ºä¿è…³æœ¬ç¬¬ä¸€è¡ŒåŒ…å«: #!/usr/bin/env node
# ä¸¦è¨­å®šåŸ·è¡Œæ¬Šé™: chmod +x .claude/hooks/security_check.js
.claude/hooks/security_check.js
```

## å®‰å…¨è€ƒé‡

### âš ï¸ å…è²¬è²æ˜

**é¢¨éšªè‡ªè² **: Claude Code Hooks æœƒåœ¨æ‚¨çš„ç³»çµ±ä¸Šè‡ªå‹•åŸ·è¡Œä»»æ„ shell å‘½ä»¤ã€‚ä½¿ç”¨ Hooks è¡¨ç¤ºæ‚¨ç¢ºèªï¼š

* æ‚¨å°é…ç½®çš„å‘½ä»¤æ‰¿æ“”å…¨éƒ¨è²¬ä»»
* Hooks å¯ä»¥ä¿®æ”¹ã€åˆªé™¤æˆ–å­˜å–æ‚¨çš„ä½¿ç”¨è€…å¸³æˆ¶èƒ½å­˜å–çš„ä»»ä½•æª”æ¡ˆ
* æƒ¡æ„æˆ–ç·¨å¯«ä¸ç•¶çš„ Hooks å¯èƒ½å°è‡´è³‡æ–™éºå¤±æˆ–ç³»çµ±æå®³
* Anthropic ä¸æä¾›ä»»ä½•ä¿è­‰ï¼Œä¸¦ä¸”ä¸å° Hook ä½¿ç”¨å°è‡´çš„ä»»ä½•æå®³æ‰¿æ“”è²¬ä»»
* æ‚¨æ‡‰è©²åœ¨ç”Ÿç”¢ç’°å¢ƒä½¿ç”¨å‰ï¼Œåœ¨å®‰å…¨ç’°å¢ƒä¸­å¾¹åº•æ¸¬è©¦ Hooks

åœ¨æ·»åŠ åˆ°æ‚¨çš„é…ç½®ä¹‹å‰ï¼Œè«‹å‹™å¿…å¯©æŸ¥ä¸¦ç†è§£ä»»ä½• Hook å‘½ä»¤ã€‚

### ğŸ›¡ï¸ é‡è¦å®‰å…¨åŸå‰‡

1. **æœ€å°æ¬Šé™åŸå‰‡**: åªæˆäºˆ Hook å®Œæˆä»»å‹™æ‰€éœ€çš„æœ€å°æ¬Šé™
2. **è¼¸å…¥é©—è­‰**: å§‹çµ‚é©—è­‰ä¾†è‡ª Claude çš„è¼¸å…¥è³‡æ–™
3. **é¿å…å‘½ä»¤æ³¨å…¥**: å¦‚æœä½¿ç”¨ä¾†è‡ª Claude çš„è³‡æ–™å»ºæ§‹å‘½ä»¤ï¼Œè«‹æ­£ç¢ºè½‰ç¾©
4. **å®šæœŸå¯©æŸ¥**: å®šæœŸæª¢æŸ¥æ‚¨çš„ Hook è¨­å®šå’ŒåŸ·è¡Œæ—¥èªŒ
5. **ä½¿ç”¨çµ•å°è·¯å¾‘**: åœ¨è…³æœ¬ä¸­ç›¡é‡ä½¿ç”¨çµ•å°è·¯å¾‘æŒ‡å®šå‘½ä»¤ï¼Œé¿å… PATH è¢«åŠ«æŒ
6. **é¿é–‹æ•æ„Ÿæª”æ¡ˆ**: è¨­å®šè¦å‰‡ä»¥è·³é `.env`, `.git/`, SSH é‡‘é‘°ç­‰æª”æ¡ˆ

### å…·é«”é˜²è­·æªæ–½

#### è¼¸å…¥æ¸…ç†ç¯„ä¾‹
```bash
# å®‰å…¨åœ°è™•ç†æª”æ¡ˆè·¯å¾‘
file_path=$(jq -r '.tool_input.file_path // ""' | sed 's/[^a-zA-Z0-9._/-]//g')

# é˜²æ­¢è·¯å¾‘éæ­·æ”»æ“Š
if [[ "$file_path" == *".."* ]]; then
    echo "âŒ ä¸å…è¨±è·¯å¾‘éæ­·æ“ä½œ"
    exit 2
fi
```

#### æ¬Šé™æª¢æŸ¥
```bash
# æª¢æŸ¥æª”æ¡ˆæ˜¯å¦åœ¨å…è¨±çš„ç›®éŒ„ä¸­
allowed_dirs=("/home/user/projects" "/tmp")
file_path=$(jq -r '.tool_input.file_path // ""')

is_allowed=false
for dir in "${allowed_dirs[@]}"; do
    if [[ "$file_path" == "$dir"* ]]; then
        is_allowed=true
        break
    fi
done

if [ "$is_allowed" = false ]; then
    echo "âŒ æª”æ¡ˆè·¯å¾‘ä¸åœ¨å…è¨±çš„ç›®éŒ„ä¸­: $file_path"
    exit 2
fi
```

### å°ˆæ¡ˆè¨­å®šå®‰å…¨æ€§

ç•¶æ‚¨è¼‰å…¥åŒ…å«å°ˆæ¡ˆç´šåˆ¥ Hooks çš„å°ˆæ¡ˆæ™‚ï¼ŒClaude Code æœƒé¡¯ç¤ºè­¦å‘Šä¸¦è¦æ±‚æ‚¨ç¢ºèªã€‚é€™æ˜¯ç‚ºäº†é˜²æ­¢æƒ¡æ„è¨­å®šæª”ã€‚

#### é…ç½®å®‰å…¨æ©Ÿåˆ¶

å°è¨­å®šæª”çš„ç›´æ¥ç·¨è¼¯ä¸æœƒç«‹å³ç”Ÿæ•ˆã€‚Claude Code æ¡ç”¨ä»¥ä¸‹å®‰å…¨æªæ–½ï¼š

1. **å•Ÿå‹•æ™‚å¿«ç…§**: Claude Code åœ¨å•Ÿå‹•æ™‚æ“·å– Hooks è¨­å®šçš„å¿«ç…§
2. **å…¨ç¨‹ä½¿ç”¨å¿«ç…§**: æ•´å€‹å°è©±æœŸé–“ä½¿ç”¨è©²å¿«ç…§
3. **å¤–éƒ¨è®Šæ›´è­¦å‘Š**: å¦‚æœ Hooks è¨­å®šæª”è¢«å¤–éƒ¨ä¿®æ”¹ï¼ŒClaude Code æœƒç™¼å‡ºè­¦å‘Š
4. **éœ€è¦å¯©æŸ¥ç¢ºèª**: è®Šæ›´å¾Œçš„ Hooks éœ€è¦åœ¨ `/hooks` ç®¡ç†ä»‹é¢ä¸­å¯©æŸ¥å¾Œæ‰èƒ½ç”Ÿæ•ˆ

é€™å¯ä»¥é˜²æ­¢æƒ¡æ„ Hook ä¿®æ”¹åœ¨æ‚¨ç›®å‰çš„å°è©±æœŸé–“ç”Ÿæ•ˆã€‚

**è«‹å‹™å¿…ï¼š**

1. **ä»”ç´°æª¢æŸ¥** `.claude/settings.json` ä¸­çš„æ‰€æœ‰ Hook å‘½ä»¤
2. **ç†è§£æ¯å€‹å‘½ä»¤çš„ä½œç”¨**ï¼Œç‰¹åˆ¥æ˜¯é‚£äº›æ‚¨ä¸ç†Ÿæ‚‰çš„
3. **åœ¨æ²™ç›’ç’°å¢ƒä¸­æ¸¬è©¦**æœªçŸ¥çš„ Hook é…ç½®
4. **ä¸è¦ç›²ç›®ä¿¡ä»»**ä¾†è‡ªç¶²è·¯çš„å°ˆæ¡ˆè¨­å®š

## ç–‘é›£æ’è§£

### å¸¸è¦‹å•é¡ŒåŠè§£æ±ºæ–¹æ¡ˆ

#### Hook æ²’æœ‰åŸ·è¡Œ

**å¯èƒ½åŸå› åŠè§£æ±ºæ–¹æ³•ï¼š**

1. **äº‹ä»¶é¡å‹æˆ–åŒ¹é…å™¨éŒ¯èª¤**
   ```bash
   # æª¢æŸ¥è¨­å®šæª”èªæ³•
   cat ~/.claude/settings.json | jq .
   ```

2. **å‘½ä»¤è·¯å¾‘å•é¡Œ**
   ```bash
   # ä½¿ç”¨çµ•å°è·¯å¾‘
   /usr/bin/echo "test" >> ~/.claude/debug.log
   ```

3. **æ¬Šé™å•é¡Œ**
   ```bash
   # æª¢æŸ¥è…³æœ¬æ¬Šé™
   chmod +x .claude/hooks/your-script.sh
   ```

#### èª¿è©¦ Hook åŸ·è¡Œ

**åœ¨ Hook ä¸­åŠ å…¥èª¿è©¦è¼¸å‡ºï¼š**
```bash
# åœ¨å‘½ä»¤é–‹é ­åŠ å…¥
set -x # æ‰“é–‹ shell çš„è©³ç´°åŸ·è¡Œæ—¥èªŒ
echo "Hook executed at $(date)" >> ~/.claude/hook-debug.log
echo "Input: $(cat)" >> ~/.claude/hook-debug.log
set +x # é—œé–‰è©³ç´°æ—¥èªŒ
```

**æª¢æŸ¥ Claude å‚³éçš„è³‡æ–™ï¼š**
```bash
# å°‡å®Œæ•´è¼¸å…¥ä¿å­˜åˆ°æª”æ¡ˆ
cat > /tmp/claude-hook-input-$(date +%s).json
```

#### JSON è§£æéŒ¯èª¤

**å®‰å…¨çš„ JSON è™•ç†ï¼š**
```bash
# æª¢æŸ¥ JSON æ˜¯å¦æœ‰æ•ˆ
if echo "$input" | jq . > /dev/null 2>&1; then
    # JSON æœ‰æ•ˆï¼Œç¹¼çºŒè™•ç†
    command=$(echo "$input" | jq -r '.tool_input.command // ""')
else
    echo "âŒ ç„¡æ•ˆçš„ JSON è¼¸å…¥" >&2
    exit 1
fi
```

### é™¤éŒ¯å·¥å…·

#### åŸºæœ¬é™¤éŒ¯æ­¥é©Ÿ

å¦‚æœæ‚¨çš„ Hooks ç„¡æ³•æ­£å¸¸é‹ä½œï¼Œè«‹ä¾åºæª¢æŸ¥ï¼š

1. **æª¢æŸ¥é…ç½®** - åŸ·è¡Œ `/hooks` æŸ¥çœ‹æ‚¨çš„ Hook æ˜¯å¦å·²è¨»å†Š
2. **é©—è­‰èªæ³•** - ç¢ºä¿ JSON è¨­å®šæœ‰æ•ˆ
3. **æ¸¬è©¦å‘½ä»¤** - å…ˆæ‰‹å‹•åŸ·è¡Œ Hook å‘½ä»¤
4. **æª¢æŸ¥æ¬Šé™** - ç¢ºä¿è…³æœ¬æª”æ¡ˆå…·æœ‰åŸ·è¡Œæ¬Šé™
5. **æŸ¥çœ‹æ—¥èªŒ** - ä½¿ç”¨ `claude --debug` æŸ¥çœ‹è©³ç´°çš„ Hook åŸ·è¡Œè³‡è¨Š

**å¸¸è¦‹å•é¡Œ:**
- **å¼•è™Ÿæœªè·³è„«** - JSON å­—ä¸²ä¸­ä½¿ç”¨ `\"` 
- **åŒ¹é…å™¨éŒ¯èª¤** - æª¢æŸ¥å·¥å…·åç¨±æ˜¯å¦ç²¾ç¢ºåŒ¹é…ï¼ˆå¤§å°å¯«æ•æ„Ÿï¼‰
- **å‘½ä»¤æ‰¾ä¸åˆ°** - ä½¿ç”¨è…³æœ¬çš„å®Œæ•´è·¯å¾‘

#### å•Ÿç”¨è©³ç´°æ—¥èªŒ
ä½¿ç”¨ `--debug` æ¨™èªŒå•Ÿå‹• Claude Code ä»¥æŸ¥çœ‹è©³ç´°çš„æ—¥èªŒè¼¸å‡ºï¼š
```bash
claude --debug
```
æ‚¨å°‡æœƒçœ‹åˆ°é¡ä¼¼ä»¥ä¸‹çš„æ—¥èªŒï¼š
```
[DEBUG] Executing hooks for PostToolUse:Write
[DEBUG] Getting matching hook commands for PostToolUse with query: Write
[DEBUG] Found 1 hook matchers in settings
[DEBUG] Matched 1 hooks for query "Write"
[DEBUG] Found 1 hook commands to execute
[DEBUG] Executing hook command: <Your command> with timeout 60000ms
[DEBUG] Hook command completed with status 0: <Your stdout>
```

é€²åº¦è¨Šæ¯æœƒå‡ºç¾åœ¨ transcript æ¨¡å¼ (Ctrl-R) ä¸­ï¼Œé¡¯ç¤ºï¼š
- æ­£åœ¨åŸ·è¡Œå“ªå€‹ Hook
- åŸ·è¡Œçš„å‘½ä»¤
- æˆåŠŸ/å¤±æ•—ç‹€æ…‹
- è¼¸å‡ºæˆ–éŒ¯èª¤è¨Šæ¯

#### é€²éšé™¤éŒ¯æŠ€å·§

å°æ–¼è¤‡é›œçš„ Hook å•é¡Œï¼š

1. **æª¢æŸ¥ Hook åŸ·è¡Œ** - ä½¿ç”¨ `claude --debug` æŸ¥çœ‹è©³ç´°çš„ Hook åŸ·è¡Œéç¨‹
2. **é©—è­‰ JSON Schema** - ä½¿ç”¨å¤–éƒ¨å·¥å…·æ¸¬è©¦ Hook è¼¸å…¥/è¼¸å‡º
3. **æª¢æŸ¥ç’°å¢ƒè®Šæ•¸** - é©—è­‰ Claude Code çš„ç’°å¢ƒæ˜¯å¦æ­£ç¢º
4. **æ¸¬è©¦é‚Šç·£æƒ…æ³** - å˜—è©¦ Hook è™•ç†ç•°å¸¸æª”æ¡ˆè·¯å¾‘æˆ–è¼¸å…¥
5. **ç›£æ§ç³»çµ±è³‡æº** - æª¢æŸ¥ Hook åŸ·è¡ŒæœŸé–“æ˜¯å¦æœ‰è³‡æºè€—ç›¡
6. **ä½¿ç”¨çµæ§‹åŒ–è¨˜éŒ„** - åœ¨ Hook è…³æœ¬ä¸­å¯¦ä½œæ—¥èªŒè¨˜éŒ„

#### Hook åŸ·è¡Œç›£æ§
```bash
# å»ºç«‹å…¨åŸŸç›£æ§ Hook
echo 'echo "$(date): Hook executed" >> ~/.claude/all-hooks.log' > ~/.claude/hooks/monitor.sh
chmod +x ~/.claude/hooks/monitor.sh
```

## æœ€ä½³å¯¦è¸ç¸½çµ

### âœ… æ¨è–¦åšæ³•

1. **å¾ç°¡å–®é–‹å§‹**: å…ˆå¯¦ä½œåŸºæœ¬çš„æ—¥èªŒè¨˜éŒ„ï¼Œå†é€æ­¥åŠ å…¥è¤‡é›œåŠŸèƒ½
2. **åˆ†å±¤è¨­å®š**: é€šç”¨è¦å‰‡æ”¾åœ¨ä½¿ç”¨è€…è¨­å®šï¼Œå°ˆæ¡ˆç‰¹å®šè¦å‰‡æ”¾åœ¨å°ˆæ¡ˆè¨­å®š
3. **å……åˆ†æ¸¬è©¦**: åœ¨å®‰å…¨ç’°å¢ƒä¸­æ¸¬è©¦æ‰€æœ‰ Hook å†éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
4. **è©³ç´°è¨»é‡‹**: åœ¨è¨­å®šæª”ä¸­ç‚ºæ¯å€‹ Hook æ·»åŠ èªªæ˜è¨»é‡‹
5. **å®šæœŸç¶­è­·**: å®šæœŸæª¢æŸ¥å’Œæ›´æ–° Hook è¨­å®šï¼Œç§»é™¤ä¸éœ€è¦çš„è¦å‰‡

### âŒ é¿å…äº‹é …

1. **éåº¦è¤‡é›œåŒ–**: é¿å…åœ¨å–®ä¸€ Hook ä¸­åŒ…å«éå¤šé‚è¼¯
2. **å¿½ç•¥éŒ¯èª¤è™•ç†**: ç¢ºä¿ Hook èƒ½å¤ å¦¥å–„è™•ç†ç•°å¸¸æƒ…æ³
3. **ç¡¬ç·¨ç¢¼è·¯å¾‘**: ä½¿ç”¨ç›¸å°è·¯å¾‘æˆ–ç’°å¢ƒè®Šæ•¸è€Œéçµ•å°è·¯å¾‘
4. **å¿½ç•¥æ•ˆèƒ½**: é¿å…åœ¨ Hook ä¸­åŸ·è¡Œè€—æ™‚æ“ä½œ
5. **ç›²ç›®ä¿¡ä»»**: ä¸è¦ç„¡æ¢ä»¶ä¿¡ä»»ä¾†è‡ªå¤–éƒ¨çš„ Hook è¨­å®š

### ğŸš€ é€²éšæŠ€å·§

1. **æ¢ä»¶åŸ·è¡Œ**: ä½¿ç”¨ç’°å¢ƒè®Šæ•¸æ§åˆ¶ Hook è¡Œç‚º
   ```bash
   if [ "$CLAUDE_ENV" = "production" ]; then
       # ç”Ÿç”¢ç’°å¢ƒå°ˆç”¨é‚è¼¯
   fi
   ```

2. **ä¸¦è¡Œè™•ç†**: å°æ–¼ç¨ç«‹çš„æ“ä½œï¼Œå¯ä»¥ä½¿ç”¨èƒŒæ™¯åŸ·è¡Œ
   ```bash
   long_running_task &
   echo "Task started in background"
   ```

3. **ç‹€æ…‹è¿½è¹¤**: ä½¿ç”¨æš«å­˜æª”æ¡ˆè¿½è¹¤ Hook ç‹€æ…‹
   ```bash
   echo "$(date): Hook started" > /tmp/claude-hook-status
   ```

4. **æ•´åˆå¤–éƒ¨æœå‹™**: é€é API èˆ‡å¤–éƒ¨æœå‹™æ•´åˆ
   ```bash
   curl -X POST "https://api.slack.com/..." -d "text=Claude completed task"
   ```

## çµèª

Claude Code Hooks æ˜¯ä¸€å€‹å¼·å¤§çš„è‡ªå‹•åŒ–å·¥å…·ï¼Œèƒ½å¤ é¡¯è‘—æå‡æ‚¨çš„é–‹ç™¼æ•ˆç‡å’Œç¨‹å¼ç¢¼å“è³ªã€‚é€éåˆç†çš„è¨­å®šå’Œä½¿ç”¨ï¼Œæ‚¨å¯ä»¥ï¼š

- ğŸ¯ **è‡ªå‹•åŒ–é‡è¤‡æ€§ä»»å‹™**: æ ¼å¼åŒ–ç¨‹å¼ç¢¼ã€åŸ·è¡Œæ¸¬è©¦ã€ç”¢ç”Ÿæ–‡ä»¶
- ğŸ›¡ï¸ **å¢å¼·å®‰å…¨æ€§**: é˜²æ­¢å±éšªæ“ä½œã€ä¿è­·æ•æ„Ÿæª”æ¡ˆ
- ğŸ“Š **æå‡å¯è¦‹åº¦**: è¨˜éŒ„æ“ä½œæ­·å²ã€ç›£æ§ç³»çµ±ç‹€æ…‹
- ğŸ”„ **å„ªåŒ–å·¥ä½œæµç¨‹**: æ•´åˆç¾æœ‰å·¥å…·éˆã€è‡ªè¨‚é€šçŸ¥æ©Ÿåˆ¶

è¨˜ä½ï¼ŒHooks çš„çœŸæ­£åƒ¹å€¼åœ¨æ–¼è®“æ‚¨å°ˆæ³¨æ–¼å‰µé€ æ€§çš„å·¥ä½œï¼Œè€Œå°‡é‡è¤‡æ€§çš„ã€è¦å‰‡åŒ–çš„ä»»å‹™äº¤çµ¦è‡ªå‹•åŒ–ç³»çµ±è™•ç†ã€‚

é–‹å§‹æ‚¨çš„ Claude Code Hooks ä¹‹æ—…ï¼Œè®“ AI åŠ©æ‰‹æˆç‚ºæ‚¨é–‹ç™¼åœ˜éšŠä¸­æœ€å¯é çš„æˆå“¡ï¼

---

## åƒè€ƒè³‡æº

- [Claude Code å®˜æ–¹æ–‡ä»¶](https://docs.anthropic.com/zh-TW/docs/claude-code/hooks)
- [jq å®˜æ–¹æ•™å­¸](https://stedolan.github.io/jq/tutorial/)
- [Shell è…³æœ¬æœ€ä½³å¯¦è¸](https://google.github.io/styleguide/shellguide.html)
- [JSON Schema é©—è­‰](https://json-schema.org/)
